---
title: AWS Lambda Web Adapterのコードを読む
published_at: 2025-12-16T00:00:00.000Z
tag: AWS, AWS Lambda, Rust
---

# AWS Lambda Web Adapterのコードを読む

## 概要

本稿では、業務で利用することになった[AWS Lambda Web Adapter](https://github.com/awslabs/aws-lambda-web-adapter)について、その内部実装をコードから読み解いていきます。
そもそも存在を知らなかった、なんとなく利用したことはあるが内部実装までは把握していなかったという方に向けて、何かしらの一助になれば幸いです。

## AWS Lambda拡張（extensions）について

AWS Lambda Web Adapterのコードを読む前に、まずは当該リポジトリのコードがAWS Lambdaにおいてどのような役割を担っているのかを把握しておくと全体感が掴みやすくなります。

とはいえ、AWS Lambdaとは、という疑問から全てをさらうには筆者の知識も時間も足りないので、必要なものを掻い摘んで紹介することとします。

最初に、AWS Lambdaには[拡張（extensions）](https://docs.aws.amazon.com/lambda/latest/dg/lambda-extensions.html)が提供されています。当機能は[2021年頃に一般公開](https://aws.amazon.com/blogs/aws/getting-started-with-using-your-favorite-operational-tools-on-aws-lambda-extensions-are-now-generally-available/)となりました。AWS Lambda拡張には内部拡張と外部拡張の二種類があり、AWS Lambda Web Adapterは外部拡張にあたります。外部拡張はLambda関数（function）とは独立したプロセスで実行されるため、Lambda関数を記述するプログラミング言語とは異なるプログラミング言語[^1]で記述することが可能です。

## Lambda実行環境のライフサイクルとAWS Lambda拡張

次に、外部拡張がLambda関数の実行に伴ってどのように関わっていくのかを見ていきます。

Lambda実行環境には`Init`->`Restore`(SnapStart利用時のみ)->`Invoke`->`Shutdown`という大枠の[ライフサイクル](https://docs.aws.amazon.com/lambda/latest/dg/lambda-runtime-environment.html)があり、`Init`フェーズ中に、`/opt/extensions`ディレクトリ以下に配置された外部拡張を探査します。

また、`Init`フェーズのサブフェーズとして`Extension init`->`Runtime init`->`Function init`のライフサイクルがあり、先ほど探査した外部拡張はこの中の`Extension init`で初期化されます。

最後に、[`Shutdown`フェーズ](https://docs.aws.amazon.com/lambda/latest/dg/lambda-runtime-environment.html#runtimes-lifecycle-shutdown)にて数時間毎に更新および保全のため、Lambda実行環境を終了します。この時、外部拡張に`Shutdown`イベントが送信されます。
何らかの理由により一定時間内に拡張機能自身が正常終了しない場合、[`SIGKILL`シグナルにより外部拡張は終了](https://github.com/aws-samples/graceful-shutdown-with-aws-lambda)します。

## AWS Lambda Web Adapter

ここからようやくAWS Lambda Web Adapterのソースコードについて触れていくことが出来ます。

まず、AWS Lambda Web AdapterのソースコードはRustで記述されています。Rustは今日では[Linuxカーネルで採用](https://rust-for-linux.com/)されたり、[Chromium](https://chromium.googlesource.com/chromium/src/+/6e25f74ea8b7f77e6b6645c765444ffa9e7ef19d/docs/rust.md)や[Firefox](https://firefox-source-docs.mozilla.org/build/buildsystem/rust.html)などのWebブラウザーおよびそのプロジェクト、JavaScriptランタイムのDenoや[AWS Lambdaの内部実装](https://github.com/firecracker-microvm/firecracker?tab=readme-ov-file#overview)など幅広い分野で採用されています。

AWS Lambda拡張とRustの親和性という点では、Lambdaは現在[`x86_64`と`arm64`の64ビット命令セットアーキテクチャをサポート](https://docs.aws.amazon.com/lambda/latest/dg/foundation-arch.html)しており、Rustのコンパイル対象として[`x86_64-unknown-linux-musl`と`aarch64-unknown-linux-musl`がサポート](https://doc.rust-lang.org/beta/rustc/platform-support.html#tier-2-with-host-tools)[^2]されていることが採用に至ったと推測できます。




[^1]: AWS Lambdaは、[OSのみのランタイム上で特定のプログラミング言語を事前コンパイルした実行可能バイナリを利用](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-provided.html)できます。
[^2]: [Rustのコンパイル](https://blog.rust-jp.rs/tatsuya6502/posts/2019-12-statically-linked-binary/)に関してはこちらがより詳しいです。